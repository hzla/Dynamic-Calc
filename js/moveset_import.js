moveChanges = {
	'Righteous Red': {
	    "Razor Wind": "Air Slash",
	    "Sky Attack": "Brave Bird",
	    "Psywave": "Bug Buzz",
	    "Fissure": "Bulldoze",
	    "Egg Bomb": "Dark Pulse",
	    "Sing": "Disarming Voice",
	    "Mega Punch": "Drain Punch",
	    "Horn Drill": "Drill Run",
	    "Aurora Beam": "Flash Cannon",
	    "Whirlwind": "Hurricane",
	    "Mist": "Icy Wind",
	    "Headbutt": "Iron Head",
	    "Guillotine": "Metal Claw",
	    "New": "Tmtrainer",
	    "Sand Attack": "Mud Slap",
	    "Thrash": "Outrage",
	    "Spike Cannon": "Rock Blast",
	    "Barrage": "Shadow Ball",
	    "Sonicboom": "Spark",
	    "Tail Whip": "Tail Slap",
	    "Gust": "Twister",
	    "Poison Gas": "Will-O-Wisp"
	},
	'Maximum Platinum': {
		"Pound": "Hidden Power Grass",
		"Payday": "Hidden Power Rock",
		"Comet Punch": "Hidden Power Ice",
		"Razor Wind": "Hidden Power Fire",
		"Gust": "Hidden Power Flying",
		"Bind": "Hidden Power Bug" ,
		"Bubble": "Hidden Power Water",
		"Take Down": "Hidden Power Electric",
		"Kinesis": "Hidden Power Ground",
		"Stockpile": "Hidden Power Psychic",
		"Spit Up": "Hidden Power Steel",
		"Swallow": "Hidden Power Fighting"
	},

	'Blaze Black 2/Volt White 2 Redux 1.4':

		{"Sand Tomb": "Accelerock",
		"Horn Drill": "Boomburst",
		"Spike Cannon": "Breaking Swipe",
		"Slam": "Brutal Swing",
		"Luster Purge": "Dazzling Gleam",
		"Round": "Disarming Voice",
		"Sweet Kiss": "Draining Kiss",
		"Vise Grip": "Dual Wingbeat",
		"Bubble": "Esper Wing",
		"Razorwind": "Fire Lash",
		"Constrict": "Infestation",
		"Rolling Kick": "Headlong Rush",
		"Mega Kick": "High Horsepower",
		"Barrage": "Lunge",
		"Mist Ball": "Moonblast",
		"Sacred Fire": "Mystical Fire",
		"Sharpen": "Nuzzle",
		"Submission": "Play Rough",
		"Comet Punch": "Power-Up Punch",
		"Egg Bomb": "Psychic Fangs",
		"Smelling Salts": "Psyshield Bash",
		"Thrash": "Raging Fury",
		"Metal Sound": "Scorching Sands",
		"Mega Punch": "Smart Strike",
		"Triple Kick": "Triple Axel",
		"Punishment": "Wave Crash"},



	"Renegade Platinum": 
		{
			"Barrage":     "Draining Kiss",
			"Brine":        "Scald",
			"Constrict":    "Icicle Crash",
			"Horn Drill":   "Drill Run",
			"Lunar Dance":  "Moonblast",
			"Luster Purge": "Dazzling Gleam",
			"Mist Ball":    "Disarming Voice",
			"Sand Tomb":    "Bulldoze",
			"Submission":   "Play Rough",
			"Twister":      "Hurricane",
			"Volt Tackle":  "Wild Charge",
			"HP Bug": "Hidden Power Bug",
			"HP Dark": "Hidden Power Dark",
			"HP Dragon": "Hidden Power Dragon",
			"HP Electric": "Hidden Power Electric",
			"HP Fighting": "Hidden Power Fighting",
			"HP Fire": "Hidden Power Fire",
			"HP Flying": "Hidden Power Flying",
			"HP Ghost": "Hidden Power Ghost",
			"HP Grass": "Hidden Power Grass",
			"HP Ground": "Hidden Power Ground",
			"HP Ice": "Hidden Power Ice",
			"HP Normal": "Hidden Power Normal",
			"HP Poison": "Hidden Power Poison",
			"HP Psychic": "Hidden Power Psychic",
			"HP Rock": "Hidden Power Rock",
			"HP Steel": "Hidden Power Steel",
			"HP Water": "Hidden Power Water",

		},
	
	"Emerald Kaizo": 
		{"Ancientpower":     "Ancient Power",
		"X-scissor":        "X-Scissor",
		"Faint Attack": "Feint Attack"},

	"Sterling Silver 1.14": 
    {
        "Defend Order": "HP Bug",
        "Dark Void": "HP Dark",
        "Twister": "HP Dragon",
        "Thunder Shock": "HP Electric",
        "Submission": "HP Fighting",
        "Ember": "HP Fire",
        "Feather Dance": "HP Flying",
        "Astonish": "HP Ghost",
        "Vine Whip": "HP Grass",
        "Mud Sport": "HP Ground",
        "Powder Snow": "HP Ice",
        "Pound": "HP Normal",
        "Sludge": "HP Poison",
        "Psywave": "HP Psychic",
        "Rock Throw": "HP Rock",
        "Iron Defense": "HP Steel",
        "Water Sport": "HP Water",
        "Charge Beam": "Volt Switch",
        "Gust": "Hurricane",
        "Magnitude": "Bulldoze",
        "Horn Drill": "Drill Run",
        "Spider Web": "Electroweb",
        "Slam": "Night Daze",
        "Fury Swipes": "Dual Chop",
        "Rollout": "Accelerock",
        "Fissure": "Headlong Rush"
    },
    "Sterling Silver 1.15": 
    {
        "Defend Order": "HP Bug",
        "Dark Void": "HP Dark",
        "Twister": "HP Dragon",
        "Thunder Shock": "HP Electric",
        "Submission": "HP Fighting",
        "Ember": "HP Fire",
        "Feather Dance": "HP Flying",
        "Astonish": "HP Ghost",
        "Vine Whip": "HP Grass",
        "Mud Sport": "HP Ground",
        "Powder Snow": "HP Ice",
        "Pound": "HP Normal",
        "Sludge": "HP Poison",
        "Psywave": "HP Psychic",
        "Rock Throw": "HP Rock",
        "Iron Defense": "HP Steel",
        "Water Sport": "HP Water",
        "Charge Beam": "Volt Switch",
        "Gust": "Hurricane",
        "Magnitude": "Bulldoze",
        "Horn Drill": "Drill Run",
        "Spider Web": "Electroweb",
        "Slam": "Night Daze",
        "Fury Swipes": "Dual Chop",
        "Rollout": "Accelerock",
        "Fissure": "Headlong Rush"
    },
    "Sterling Silver 1.16": 
    {
        "Defend Order": "HP Bug",
        "Dark Void": "HP Dark",
        "Twister": "HP Dragon",
        "Thunder Shock": "HP Electric",
        "Submission": "HP Fighting",
        "Ember": "HP Fire",
        "Feather Dance": "HP Flying",
        "Astonish": "HP Ghost",
        "Vine Whip": "HP Grass",
        "Mud Sport": "HP Ground",
        "Powder Snow": "HP Ice",
        "Pound": "HP Normal",
        "Sludge": "HP Poison",
        "Psywave": "HP Psychic",
        "Rock Throw": "HP Rock",
        "Iron Defense": "HP Steel",
        "Water Sport": "HP Water",
        "Charge Beam": "Volt Switch",
        "Gust": "Hurricane",
        "Magnitude": "Bulldoze",
        "Horn Drill": "Drill Run",
        "Spider Web": "Electroweb",
        "Slam": "Night Daze",
        "Fury Swipes": "Dual Chop",
        "Rollout": "Accelerock",
        "Fissure": "Headlong Rush"
    },
    "Sterling Silver 1.17": 
    {
        "Defend Order": "HP Bug",
        "Dark Void": "HP Dark",
        "Twister": "HP Dragon",
        "Thunder Shock": "HP Electric",
        "Submission": "HP Fighting",
        "Ember": "HP Fire",
        "Feather Dance": "HP Flying",
        "Astonish": "HP Ghost",
        "Vine Whip": "HP Grass",
        "Mud Sport": "HP Ground",
        "Powder Snow": "HP Ice",
        "Pound": "HP Normal",
        "Sludge": "HP Poison",
        "Psywave": "HP Psychic",
        "Rock Throw": "HP Rock",
        "Iron Defense": "HP Steel",
        "Water Sport": "HP Water",
        "Charge Beam": "Volt Switch",
        "Gust": "Hurricane",
        "Magnitude": "Bulldoze",
        "Horn Drill": "Drill Run",
        "Spider Web": "Electroweb",
        "Slam": "Night Daze",
        "Fury Swipes": "Dual Chop",
        "Rollout": "Accelerock",
        "Fissure": "Headlong Rush"
    },
    "Platinum Redux 2.6": 
    {
	    "Mega Punch": "Scrap Steal",
	    "Vice Grip": "Draconic Slam",
	    "Razor Wind": "Distract",
	    "Whirlwind": "Obliterate",
	    "Bind": "Horror Scream",
	    "Slam": "Scorching Sands",
	    "Stomp": "Fog Ball",
	    "Double Kick": "Draconic Gale",
	    "Mega Kick": "Galactic Edge",
	    "Jump Kick": "Lightning Rush",
	    "Wrap": "Combustion",
	    "Take Down": "Battering Ram",
	    "Roar": "Heavy Slam",
	    "Disable": "Wyvery Blaze",
	    "Mist": "Mystical Mist",
	    "Psybeam": "Braindrain",
	    "Peck": "Drill Run",
	    "Low Kick": "Even Ground",
	    "Rage": "Skitter Smack",
	    "Mimic": "Misdirection",
	    "Double Team": "Acidic Payback",
	    "Minimize": "Parasite",
	    "Bide": "Cyclone",
	    "Metronome": "Chi Pulse",
	    "Mirror Move": "Headlong Rush",
	    "Self-Destruct": "Spark",
	    "Egg Bomb": "Egg Impact",
	    "Clamp": "Razor Shell",
	    "Spike Cannon": "Spike Barrage",
	    "Barrage": "Boulder Drop",
	    "Sky Attack": "Incinerate",
	    "Transform": "Poltergeist",
	    "Spore": "Wave Crash",
	    "Psywave": "Noxious Blast",
	    "Splash": "Boulder Fling",
	    "Explosion": "Hyper Rest",
	    "Conversion": "Subzero Slam",
	    "Substitute": "Jet Stream",
	    "Sketch": "Chakra Push",
	    "Triple Kick": "Arcane Gambit",
	    "Thief": "Searing Blow",
	    "Spider Web": "Uproar",
	    "Mind Reader": "Infection",
	    "Flame Wheel": "Flame Charge",
	    "Snore": "Disaster Strike",
	    "Flail": "Pheromone Gale",
	    "Conversion 2": "Venom Bash",
	    "Reversal": "Mind Strike",
	    "Sweet Kiss": "Takeoff",
	    "Belly Drum": "Lock-On",
	    "Foresight": "Liquid Steel",
	    "Destiny Bond": "Umbral Arrival",
	    "Perish Song": "Ingrain",
	    "Detect": "Rust Storm",
	    "Bone Rush": "Narcotic Spore",
	    "Lock-On": "Rusty Swipes",
	    "False Swipe": "Scale Smash",
	    "Spark": "Volt Switch",
	    "Mean Look": "Blazing Bash",
	    "Attract": "Exorcism",
	    "Sleep Talk": "Terrifier",
	    "Present": "Frozen Present",
	    "Frustration": "Titan Jaw",
	    "Safeguard": "Acid Darts",
	    "Baton Pass": "Accelegem",
	    "Encore": "Berserk",
	    "Pursuit": "Sinister Strike",
	    "Vital Throw": "Force Push",
	    "Psych Up": "Short Circuit",
	    "Future Sight": "Fiery Fury",
	    "Beat Up": "Electro Shove",
	    "Uproar": "Shrill Noise",
	    "Stockpile": "Lightning Storm",
	    "Spit Up": "Destruction",
	    "Swallow": "Sharp Pecker",
	    "Flatter": "Chilly Tempest",
	    "Memento": "Meteor Beam",
	    "Facade": "Wet Touch",
	    "SmellingSalt": "Plasma Touch",
	    "Follow Me": "Pollen Puff",
	    "Nature Power": "Icky Trap",
	    "Charge": "Charged Water",
	    "Taunt": "Phantasm",
	    "Helping Hand": "Bulldoze",
	    "Trick": "Terraforming",
	    "Role Play": "Pensive Tackle",
	    "Assist": "Reckless Peck",
	    "Ingrain": "Rage",
	    "Recycle": "Spider Web",
	    "Revenge": "Counter Strike",
	    "Endeavor": "Avalanche",
	    "Skill Swap": "Techno Blast",
	    "Imprison": "Baneful Sting",
	    "Refresh": "Acid Downpour",
	    "Grudge": "Psychic Fangs",
	    "Snatch": "Bedrock Crush",
	    "Dive": "Metal Chips",
	    "Arm Thrust": "Power-Up Punch",
	    "Camouflage": "Splish Splash",
	    "Mist Ball": "Psybeam",
	    "Teeter Dance": "Crush",
	    "Crush Claw": "Tear Up",
	    "Fake Tears": "Uncover",
	    "Odor Sleuth": "Ambush",
	    "Tickle": "Nightfall",
	    "Extrasensory": "Mind Crush",
	    "Muddy Water": "Foul Water",
	    "Block": "Ascending Wind",
	    "Howl": "Phantom Force",
	    "Rock Blast": "Stone Barrage",
	    "Water Pulse": "H2O Absorption",
	    "Wake-Up Slap": "Dragon Chop",
	    "Gyro Ball": "Wild Charge",
	    "Brine": "Scald",
	    "Feint": "Freeze Strike",
	    "Payback": "Scam",
	    "Assurance": "Venom Touch",
	    "Embargo": "Sonic Missile",
	    "Fling": "Glacial Twist",
	    "Psycho Shift": "Haunting",
	    "Trump Card": "Pyro Twist",
	    "Heal Block": "Current Pursuit",
	    "Wring Out": "Sleight of Hand",
	    "Power Trick": "Silk Spin",
	    "Gastro Acid": "Napalm Strike",
	    "Guard Swap": "Condemnation",
	    "Worry Seed": "Bolt Strike",
	    "Heart Swap": "Judgment",
	    "Force Palm": "Power Reset",
	    "Vacuum Wave": "Vacuum Swipe",
	    "Earth Power": "Tectonic Shift",
	    "Avalanche": "Ice Burn",
	    "Defog": "Heavy Storm",
	    "Captivate": "Frost Drain",
	    "Judgment": "Meteor Impact",
	    "Attack Order": "Assault Order",
	    "Double Hit": "Dark Hole",
	    "Spacial Rend": "Spacial Rupture"
	},
	"Pitch Black 2": {
        "Sand Tomb": "Accelerock",
        "Horn Drill": "Boomburst",
        "Spike Cannon": "Breaking Swipe",
        "Slam": "Brutal Swing",
        "Luster Purge": "Dazzling Gleam",
        "Round": "Disarming Voice",
        "Sweet Kiss": "Draining Kiss",
        "ViceGrip": "Dual Wingbeat",
        "Bubble": "Esper Wing",
        "Razor Wind": "Fire Lash",
        "Constrict": "Infestation",
        "Rolling Kick": "Headlong Rush",
        "Mega Kick": "High Horsepower",
        "Barrage": "Lunge",
        "Mist Ball": "Moonblast",
        "Sacred Fire": "Mystical Fire",
        "Sharpen": "Nuzzle",
        "Submisson": "Play Rough",
        "Comet Punch": "Power-Up Punch",
        "Egg Bomb": "Psychic Fangs",
        "Smelling Salts": "Psyshield Bash",
        "Thrash": "Raging Fury",
        "Metal Sound": "Scorching Sands",
        "Mega Punch": "Smart Strike",
        "Triple Kick": "Triple Axel",
        "Punishment": "Wave Crash",
        "Secret Sword": "Spirit Break",
        "Sheer Cold": "Mountain Gale",
        "Splash": "Parabolic Charge",
        "Fissure": "Sandsear Storm",
        "Guillotine": "Bleakwind Storm",
        "Clamp": "Wildbolt Storm"
    },
    "Cascade White 2": {
    	"Rollout": "Accelerock",
		"Heart Swap": "Boomburst",
		"Withdraw": "Breaking Swipe",
		"Slam": "Brutal Swing",
		"Luster Purge": "Dazzling Gleam",
		"Round": "Disarming Voice",
		"Sweet Kiss": "Draining Kiss",
		"Vise Grip": "Dual Wingbeat",
		"Sky Attack": "Esper Wing",
		"Constrict": "Infestation",
		"Rolling Kick": "Headlong Rush",
		"Mega Kick": "High Horsepower",
		"Kinesis": "Lunge",
		"Mist Ball": "Moonblast",
		"Sacred Fire": "Mystical Fire",
		"Submission": "Play Rough",
		"Sand Attack": "Scorching Sands",
		"Triple Kick": "Triple Axel",
		"Punishment": "Wave Crash",
		"Attack Order": "Scorching Swarm",
		"Spacial Rend": "Steel Beam",
		"Roar of Time": "Starburst",
		"Sharpen": "Nuzzle	",
		"Razor Wind": "Fire Lash",
		"Smelling Salts": "Psychic Fangs",
		"Conversion": "Flip Turn",
		"Mean Look": "Barb Barrage",
		"Spider Web": "Infernal Parade",
		"Lock On": "Parting Shot",
		"Block": "Ice Hammer",
		"Camouflage": "Trop Kick",
		"Conversion 2": "Spin Out",
		"Mind Reader": "Snap Trap",
		"Bubble": "Chilling Water",
		"Transform": "Phantom Force",
		"Splash": "Spirit Break",
		"Aqua Ring": "Fairy Wind",
		"Charge": "Parabolic Charge",
		"False Swipe": "Body Press",
		"Miracle Eye": "Freeze-Dry",
		"Freeze Shock": "Meteor Beam", 
		"Flash": "Sparkle",
		"Ice Burn": "Solar Blade",
		"Torment": "Petal Blizzard",
		"Fury Attack": "Razor Winds",
		"Transform": "Phantom Strike",
		"Chip Away": "Hidden Force",
		"False Swipe": "Body Press"

	}
}

abilityChanges = {
	"Cascade White 2": {
		"Tinted Lens": "Tenacity",
		"Shieled Dust": "Resilient",
		"Compoundeyes": "Keen Senses",
		"Analytic": "Patient",
		"Mummy": "Contagious",
		"Clear Body": "Strong Body",
		"Download": "Exploit",
		"Rock Head": "Determined",
		"Victory Star": "Illumination",
		"Multiscale": "Majestic Ward",
		"Light Metal": "Tough Claws",
		"Pickup": "Fluffy",
		"Gooey": "Cute Charm",
		"Heavy Metal": "Slush Rush",
		"Limber": "Corrosion"
	}
}

itemChanges = {
	"Cascade White 2": {
		"Power Bracer": "Assault Vest",
		"Adamant Orb": "Fairy Dust",
		"Lustrous Orb": "Pixie Plate",
		"Power Belt": "Fairy Gem",
		"Lansat Berry": "Roseli Berry",
		"Ring Target": "Lucky Charm",
		"Resist Wing": "Throat Spray",
		"Metal Powder": "Stress Tester",
		"Power Anklet": "Safety Goggles",
		"Power Lens": "Weakness Policy"
	}
}


if(typeof CHANGES === 'undefined') {
	
} else {
	moveChanges["NONE"] = CHANGES
}


function placeBsBtn() {
	var importBtn = "<button id='import' class='bs-btn bs-btn-default'>Import</button>";
	$("#import-1_wrapper").append(importBtn);

	$("#import.bs-btn").click(function () {
		var pokes = document.getElementsByClassName("import-team-text")[0].value;
		var name = document.getElementsByClassName("import-name-text")[0].value.trim() === "" ? "Custom Set" : document.getElementsByClassName("import-name-text")[0].value;
		addSets(pokes, name);
	});
}

function ExportPokemon(pokeInfo) {
	var pokemon = createPokemon(pokeInfo);
	var EV_counter = 0;
	var finalText = "";
	finalText = pokemon.name + (pokemon.item ? " @ " + pokemon.item : "") + "\n";
	finalText += "Level: " + pokemon.level + "\n";
	finalText += pokemon.nature && gen > 2 ? pokemon.nature + " Nature" + "\n" : "";
	finalText += pokemon.ability ? "Ability: " + pokemon.ability + "\n" : "";
	if (gen > 2) {
		var EVs_Array = [];
		for (var stat in pokemon.evs) {
			var ev = pokemon.evs[stat] ? pokemon.evs[stat] : 0;
			if (ev > 0) {
				EVs_Array.push(ev + " " + calc.Stats.displayStat(stat));
			}
			EV_counter += ev;
			if (EV_counter > 510) break;
		}
		if (EVs_Array.length > 0) {
			finalText += "EVs: ";
			finalText += serialize(EVs_Array, " / ");
			finalText += "\n";
		}
	}

	var IVs_Array = [];
	for (var stat in pokemon.ivs) {
		var iv = pokemon.ivs[stat] ? pokemon.ivs[stat] : 0;
		if (iv < 31) {
			IVs_Array.push(iv + " " + calc.Stats.displayStat(stat));
		}
	}
	if (IVs_Array.length > 0) {
		finalText += "IVs: ";
		finalText += serialize(IVs_Array, " / ");
		finalText += "\n";
	}

	for (var i = 0; i < 4; i++) {
		var moveName = pokemon.moves[i].name;
		if (moveName !== "(No Move)") {
			finalText += "- " + moveName + "\n";
		}
	}
	finalText = finalText.trim();
	$("textarea.import-team-text").val(finalText);
}

$("#exportL").click(function () {
	ExportPokemon($("#p1"));
});

$('#save-pok').click(function () {
	ExportPokemon($("#p1"));
	$('#import').click()
	$(this).text("Saved!")

	if (saveUploaded) {
		updatePartyPKMN()
	}

	$('.import-team-text').val("")
	
	setTimeout(function() {
		$('#save-pok').text("Save")
	}, 500)
})

$("#exportR").click(function () {
	ExportPokemon($("#p2"));
});

function serialize(array, separator) {
	var text = "";
	for (var i = 0; i < array.length; i++) {
		if (i < array.length - 1) {
			text += array[i] + separator;
		} else {
			text += array[i];
		}
	}
	return text;
}

function getAbility(row, species=false) {
	var ability = row[1] ? row[1].trim() : '';

	
	if (calc.ABILITIES[8].indexOf(ability) !== -1) {
		if (abilityChanges[TITLE] && abilityChanges[TITLE][ability]) {
			return abilityChanges[TITLE][ability]
		}
		return ability;
	} 
}

function statToLegacyStat(stat) {
	switch (stat) {
	case 'hp':
		return "hp";
	case 'atk':
		return "at";
	case 'def':
		return "df";
	case 'spa':
		if (damageGen == 1) {
			return "sl";
		}
		return "sa";
	case 'spd':
		return "sd";
	case 'spe':
		return "sp";
	}
}

function getStats(currentPoke, rows, offset) {
	currentPoke.nature = "Serious";
	var currentEV;
	var currentIV;
	var currentAbility;
	var currentNature;
	var natureIsSet = false
	currentPoke.level = 100;
	for (var x = offset; x < offset + 8; x++) {
		var currentRow = rows[x] ? rows[x].split(/[/:]/) : '';
		var evs = {};
		var ivs = {};
		var ev;
		var j;

		switch (currentRow[0]) {
		case 'Level':
			currentPoke.level = parseInt(currentRow[1].trim());
			break;
		case 'EVs':
			for (j = 1; j < currentRow.length; j++) {
				currentEV = currentRow[j].trim().split(" ");
				currentEV[1] = statToLegacyStat(currentEV[1].toLowerCase());
				evs[currentEV[1]] = parseInt(currentEV[0]);
			}
			currentPoke.evs = evs;
			break;
		case 'IVs':
			for (j = 1; j < currentRow.length; j++) {
				currentIV = currentRow[j].trim().split(" ");
				currentIV[1] = statToLegacyStat(currentIV[1].toLowerCase());
				ivs[currentIV[1]] = parseInt(currentIV[0]);
			}
			currentPoke.ivs = ivs;
			break;

		}
		currentAbility = rows[x] ? rows[x].trim().split(":") : '';
		if (currentAbility[0] == "Ability") {
			currentPoke.ability = currentAbility[1].trim();
			if (abilityChanges[TITLE] && abilityChanges[TITLE][currentPoke.ability]) {
				currentPoke.ability = abilityChanges[TITLE][currentPoke.ability]
			}
		}

		currentNature = rows[x] ? rows[x].trim().split(" ") : '';
		if (currentNature[1] == "Nature" && !natureIsSet) {
			currentPoke.nature = currentNature[0];
			natureIsSet = true
		}
	}
	return currentPoke;
}

function isInt(value) {
  return !isNaN(value) && 
         parseInt(Number(value)) == value && 
         !isNaN(parseInt(value, 10));
}

function getItem(currentRow, j) {
	for (;j < currentRow.length; j++) {
		var item = currentRow[j].trim();
		item = item.replace("’", "'");
		if (calc.ITEMS[8].indexOf(item) != -1) {
			if (itemChanges[TITLE] && itemChanges[TITLE][item]) {
				return itemChanges[TITLE][item]
			}
			return item;
		}
	}
}

function getMoves(currentPoke, rows, offset) {
	var movesFound = false;
	var moves = [];
	for (var x = offset; x < offset + 12; x++) {
		if (rows[x]) {
			if (rows[x][0] == "-") {
				movesFound = true;
				var move = rows[x].substr(2, rows[x].length - 2).replace("[", "").replace("]", "").replace("  ", "");


				if (moveChanges[TITLE]) {
					if (moveChanges[TITLE][move]) {
						move = moveChanges[TITLE][move]
					}
				}

				// ignore hacks with predefined hidden power
				if (!TITLE.includes("Sterling") && !TITLE.includes("Maximum") && !TITLE.includes("Ancestral")) {
					move = move.replace("HP ", "Hidden Power")
				}

				if (typeof rows[x + 1] != "undefined" && rows[x + 1][0] == "M") {
					currentPoke.met = rows[x + 1].substr(5, rows[x + 1].length)
				}

				moves.push(move);
			} else {
				if (movesFound == true) {
					break;
				}
			}
		}
	}
	currentPoke.moves = moves;
	return currentPoke;
}

function addToDex(poke) {
	var dexObject = {};


	if (typeof npoint_data.poks_replacements != "undefined") {
		if (typeof pokChanges === "undefined") {
			pokChanges = {}
		}
		
		pokChanges[TITLE] = npoint_data.poks_replacements

		if (pokChanges[TITLE] && pokChanges[TITLE][poke.name]) {
			poke.name = pokChanges[TITLE][poke.name] 
		}
	}

	
	if ($("#randoms").prop("checked")) {
		if (GEN8RANDOMBATTLE[poke.name] == undefined) GEN8RANDOMBATTLE[poke.name] = {};
		if (GEN7RANDOMBATTLE[poke.name] == undefined) GEN7RANDOMBATTLE[poke.name] = {};
		if (GEN6RANDOMBATTLE[poke.name] == undefined) GEN6RANDOMBATTLE[poke.name] = {};
		if (GEN5RANDOMBATTLE[poke.name] == undefined) GEN5RANDOMBATTLE[poke.name] = {};
		if (GEN4RANDOMBATTLE[poke.name] == undefined) GEN4RANDOMBATTLE[poke.name] = {};
		if (GEN3RANDOMBATTLE[poke.name] == undefined) GEN3RANDOMBATTLE[poke.name] = {};
		if (GEN2RANDOMBATTLE[poke.name] == undefined) GEN2RANDOMBATTLE[poke.name] = {};
		if (GEN1RANDOMBATTLE[poke.name] == undefined) GEN1RANDOMBATTLE[poke.name] = {};
	} else {
		if (SETDEX_SS[poke.name] == undefined) SETDEX_SS[poke.name] = {};
		if (SETDEX_SM[poke.name] == undefined) SETDEX_SM[poke.name] = {};
		if (SETDEX_XY[poke.name] == undefined) SETDEX_XY[poke.name] = {};
		if (SETDEX_BW[poke.name] == undefined) SETDEX_BW[poke.name] = {};
		if (SETDEX_DPP[poke.name] == undefined) SETDEX_DPP[poke.name] = {};
		if (SETDEX_ADV[poke.name] == undefined) SETDEX_ADV[poke.name] = {};
		if (SETDEX_GSC[poke.name] == undefined) SETDEX_GSC[poke.name] = {};
		if (SETDEX_RBY[poke.name] == undefined) SETDEX_RBY[poke.name] = {};
	}
	if (poke.ability !== undefined) {
		dexObject.ability = poke.ability;
	}



	if (isInt(poke.ability)) {
		console.log("ability updated")
		dexObject.ability = pokedex[poke.name]['abilities'][parseInt(poke.ability)]
	}
	

	dexObject.level = poke.level;
	dexObject.evs = poke.evs;
	dexObject.ivs = poke.ivs;
	dexObject.moves = poke.moves;
	dexObject.nature = poke.nature;
	dexObject.item = poke.item;
	dexObject.nn = poke.nn
	dexObject.isCustomSet = poke.isCustomSet;

	if (typeof poke["met"] != "undefined") {
		dexObject.met = poke["met"] 
	}

	var customsets;
	if (localStorage.customsets) {
		customsets = JSON.parse(localStorage.customsets);
	} else {
		customsets = {};
	}
	// console.log(poke.nameProp)

	if (!customsets[poke.name]) {
		customsets[poke.name] = {};
	}

	customsets[poke.name]["My Box"] = dexObject;
	
	


	if (poke.name === "Aegislash-Blade") {
		if (!customsets["Aegislash-Shield"]) {
			customsets["Aegislash-Shield"] = {};
		}
		customsets["Aegislash-Shield"][poke.nameProp] = dexObject;
	}


	updateDex(customsets);
}

function updateDex(customsets) {
	for (var pokemon in customsets) {
		for (var moveset in customsets[pokemon]) {
			if (!SETDEX_SS[pokemon]) SETDEX_SS[pokemon] = {};
			SETDEX_SS[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_SM[pokemon]) SETDEX_SM[pokemon] = {};
			SETDEX_SM[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_XY[pokemon]) SETDEX_XY[pokemon] = {};
			SETDEX_XY[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_BW[pokemon]) SETDEX_BW[pokemon] = {};
			SETDEX_BW[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_DPP[pokemon]) SETDEX_DPP[pokemon] = {};
			SETDEX_DPP[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_ADV[pokemon]) SETDEX_ADV[pokemon] = {};
			SETDEX_ADV[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_GSC[pokemon]) SETDEX_GSC[pokemon] = {};
			SETDEX_GSC[pokemon][moveset] = customsets[pokemon][moveset];
			if (!SETDEX_RBY[pokemon]) SETDEX_RBY[pokemon] = {};
			SETDEX_RBY[pokemon][moveset] = customsets[pokemon][moveset];
		}
	}
	localStorage.customsets = JSON.stringify(customsets);
}

function isValidJSON(str) {
    try {
        JSON.parse(str);
        return true;
    } catch (error) {
        return false;
    }
}

function addSets(pokes, name) {
	if (isValidJSON(pokes)) {
		newSets = JSON.parse(pokes)
		localStorage.customsets = newSets
		location.reload()
		return

		// for (let set in newSets) {
		// 	SETDEX_BW[set] ||= {}
		// 	SETDEX_BW[set]["My Box"] = newSets[set]["My Box"]
		// }
		// console.log("sets updated")
		// get_box()
		// return
	}	

	var rows = pokes.split("\n");
	var currentRow;
	var currentPoke;
	var addedpokes = 0;
	// currentParty = []
	for (var i = 0; i < rows.length; i++) {
		var item = false
		// if (rows[i].split(" |Party")[1]) {
		// 	if (rows[i].includes("@")) {
		// 		item = rows[i].split("@")[1].trim()
		// 	}
		// 	rows[i] = rows[i].split(" |Party")[0]
		// 	currentParty.push(rows[i])
		// }


		currentRow = rows[i].split(/[()@]/);
		
		if (item) {
			currentRow.push(item)
		}
		
		
		for (var j = 0; j < currentRow.length; j++) {
			currentRow[j] = checkExeptions(currentRow[j].trim());
			if (calc.SPECIES[8][currentRow[j].trim()] !== undefined) {
				currentPoke = calc.SPECIES[8][currentRow[j].trim()];
				currentPoke.name = currentRow[j].trim();
				currentPoke.item = getItem(currentRow, j + 1);
				if (j === 1 && currentRow[0].trim()) {
					currentPoke.nameProp = "My Box";
					currentPoke.nn = currentRow[0].trim()
				} else {
					currentPoke.nameProp = "My Box";
				}
				currentPoke.isCustomSet = true;

				if (INC_EM) {
					currentPoke.ability = getAbility(rows[i + 4].split(":"), currentPoke.name);
				} else {
					currentPoke.ability = getAbility(rows[i + 1].split(":"));
				}
				
				currentPoke = getStats(currentPoke, rows, i + 1);
				currentPoke = getMoves(currentPoke, rows, i);
				addToDex(currentPoke);
				addedpokes++;
			}
		}
	}
	if (addedpokes > 0) {
		get_box()
		// alert("Successfully imported " + addedpokes + " set(s)");
		$('.player-poks').addClass('shake')
		customSets = JSON.parse(localStorage.customsets);
		setTimeout(function(){
			$('.player-poks').removeClass('shake')
		}, 500)
		$(allPokemon("#importedSetsOptions")).css("display", "inline");
		displayParty()
		importEncounters()

		if (splitData[TITLE]) {
			$('#fragsheet-howto').show()
		}
	} else {
		alert("No sets imported, please check your syntax and try again");
	}
	 $(".trainer-pok.left-side" ).attr("draggable", "true")
}







function checkExeptions(poke) {
	switch (poke) {
	case 'Aegislash':
		poke = "Aegislash-Shield";
		break;
	case 'Basculin-Blue-Striped':
		poke = "Basculin";
		break;
	case 'Gastrodon-East':
		poke = "Gastrodon";
		break;
	case 'Mimikyu-Busted-Totem':
		poke = "Mimikyu-Totem";
		break;
	case 'Mimikyu-Busted':
		poke = "Mimikyu";
		break;
	case 'Pikachu-Belle':
	case 'Pikachu-Cosplay':
	case 'Pikachu-Libre':
	case 'Pikachu-Original':
	case 'Pikachu-Partner':
	case 'Pikachu-PhD':
	case 'Pikachu-Pop-Star':
	case 'Pikachu-Rock-Star':
		poke = "Pikachu";
		break;
	case 'Vivillon-Fancy':
	case 'Vivillon-Pokeball':
		poke = "Vivillon";
		break;
	case 'Flabébé-White':
	case 'Flabébé-Blue':
	case 'Flabébé-Orange':
	case 'Flabébé-Yellow':
		poke = "Flabébé";
		break;
	case 'Floette-White':
	case 'Floette-Blue':
	case 'Floette-Orange':
	case 'Floette-Yellow':
		poke = "Floette";
		break;
	case 'Florges-White':
	case 'Florges-Blue':
	case 'Florges-Orange':
	case 'Florges-Yellow':
		poke = "Florges";
		break;
	}

	// try replacing spaces with dashes
	if (typeof pokedex[poke] == 'undefined' && pokedex[poke.replace(" ", "-")]) {
		poke = poke.replace(" ", "-")
		return poke
	}

	// try replacing dashes with spaces
	if (typeof pokedex[poke] == 'undefined' && pokedex[poke.replace("-", " ")]) {
		poke = poke.replace("-", " ")
		return poke
	}

	// try using only first part of name
	if (typeof pokedex[poke] == 'undefined' && pokedex[poke.split("-")[0]]) {
		poke = poke.split("-")[0]
		return poke
	}


	return poke;

}

$("#clearSets").click(function () {
	localStorage.removeItem("customsets");
	$("#importedSetsOptions").hide();
	
	// Remove Set Data from Dropdown
	$('.trainer-pok.left-side').each(function() {
		var species_name = $(this).attr('data-id').replace(" (My Box)", "")
		delete SETDEX_BW[species_name]["My Box"]
	})

	// Remove Icons
	$('.trainer-pok.left-side').remove()
	$('#clear-party').click()

	// Shake box
	$('.player-poks').addClass('shake')
	setTimeout(function(){
		$('.player-poks').removeClass('shake')
	}, 500)

});

$("#importedSets").click(function () {
	var pokeID = "p1";
	var showCustomSets = $(this).prop("checked");
	if (showCustomSets) {
		loadCustomList(pokeID);
	} else {
		loadDefaultLists();
	}
});

$(document).ready(function () {
	// customSets;
	placeBsBtn();
	if (localStorage.customsets) {
		customSets = JSON.parse(localStorage.customsets);

		// updateDex(customSets);
		$(allPokemon("#importedSetsOptions")).css("display", "inline");
	} else {
		loadDefaultLists();
	}
});
